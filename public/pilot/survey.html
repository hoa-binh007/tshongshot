<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Survey</title>
  <link rel="stylesheet" href="app.css"/>

  <style>
    /* Minimal, damit die Skalen sichtbar + aktiv sind (falls app.css es nicht hat) */
    .q-title { font-weight: 700; margin-bottom: 8px; }
    .choices { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .choice { display: flex; gap: 10px; align-items: center; }
    .scale { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .dot { min-width: 38px; height: 38px; border-radius: 999px; border: 1px solid #666; background: transparent; color: inherit; cursor: pointer; }
    .dot.active { background: #e31e24 !important; color: #fff !important; border-color: #e31e24 !important; }
    .pilot-meta select { background: transparent; color: inherit; border: 1px solid #555; border-radius: 10px; }
    .pilot-meta option { color: #000; }
  </style>
</head>

<body>

   <div class="wrap">

    <div class="card">

      <!-- HEADER ganz oben im Blatt -->
      <div class="row">
        <div class="small" data-de="Umfrage" data-vi="Kh·∫£o s√°t" data-en="Survey"></div>
        <div class="lang">
          <button id="btnVi" type="button">üáªüá≥</button>
          <button id="btnEn" type="button">üá¨üáß</button>
          <button id="btnDe" type="button">üá©üá™</button>
        </div>
      </div>


    <!-- META (optional) -->
    <div class="pilot-meta" style="margin:12px 0; padding:12px; border:1px solid #333; border-radius:10px;">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <label style="flex:1; min-width:160px;">
          <div style="font-weight:600; margin-bottom:6px;"
               data-de="Rolle (optional)"
               data-vi="Vai tr√≤ (t√πy ch·ªçn)"
               data-en="Role (optional)"></div>

          <select id="role" style="width:100%; padding:8px;">
            <option value="" data-de="(√ºberspringen)" data-vi="(b·ªè qua)" data-en="(skip)"></option>
            <option value="consumer" data-de="Konsument" data-vi="Ng∆∞·ªùi d√πng" data-en="Consumer"></option>
            <option value="expert" data-de="Experte" data-vi="Chuy√™n gia" data-en="Expert"></option>
            <option value="internal" data-de="Intern (Firma)" data-vi="N·ªôi b·ªô (c√¥ng ty)" data-en="Internal (company)"></option>
          </select>
        </label>

        <label style="flex:3; min-width:160px;">
          <div style="font-weight:600; margin-bottom:6px;"
               data-de="Stadt (optional)"
               data-vi="Th√†nh ph·ªë (t√πy ch·ªçn)"
               data-en="City (optional)"></div>

         <select id="city" style="width:100%; padding:8px;" required>
  <option value="DaLat" selected>Da Lat</option>
  <option value="Saigon">Ho Chi Minh City</option>
</select>

        </label>
      </div>

      <div style="margin-top:8px; font-size:0.9em; opacity:0.8;"
           data-de="Hilft uns beim Vergleich der Standorte."
           data-vi="Gi√∫p ch√∫ng t√¥i so s√°nh gi·ªØa c√°c th√†nh ph·ªë."
           data-en="Helps us compare cities/experts."></div>
    </div>

    <div class="card">
      <h1 data-de="Schnellumfrage (Final v2.1)"
          data-vi="Kh·∫£o s√°t nhanh (B·∫£n cu·ªëi v2.1)"
          data-en="Quick survey (Final v2.1)"></h1>

      <p data-de="Anonym. Schnell tippen."
         data-vi="Ch·ªçn nhanh. ·∫®n danh."
         data-en="Tap quickly. Anonymous."></p>

      
         <form id="surveyForm">

  <!-- META -->
  <div class="card">
    <div class="row">
      <div class="field">
        <label>M√£ s·ªë</label>
        <input type="text" name="id" placeholder="VD: DL001">
      </div>

      <div class="field">
        <label>Ng√†y</label>
        <input type="datetime-local" name="started_at_local" id="startedAtLocal">
      </div>
    </div>

    <div class="field">
      <label>ƒê·ªãa ƒëi·ªÉm</label>
      <label><input type="radio" name="location" value="dalat"> ƒê√† L·∫°t</label>
      <label><input type="radio" name="location" value="saigon"> S√†i G√≤n</label>
    </div>
  </div>

  <!-- 1 -->
  <div class="card">
    <h3>1. H∆∞∆°ng v·ªã</h3>
    <label><input type="radio" name="taste" value="5"> R·∫•t ngon</label>
    <label><input type="radio" name="taste" value="4"> Ngon</label>
    <label><input type="radio" name="taste" value="3"> B√¨nh th∆∞·ªùng</label>
    <label><input type="radio" name="taste" value="2"> Kh√¥ng ngon</label>
    <label><input type="radio" name="taste" value="1"> R·∫•t kh√≥ u·ªëng</label>
  </div>

  <!-- 2 -->
  <div class="card">
    <h3>2. Sau khi u·ªëng b·∫°n c√≥ th·∫•y t·ªânh t√°o h∆°n?</h3>
    <label><input type="radio" name="energy" value="yes"> C√≥</label>
    <label><input type="radio" name="energy" value="little"> M·ªôt ch√∫t</label>
    <label><input type="radio" name="energy" value="no"> Kh√¥ng</label>
    <label><input type="radio" name="energy" value="unsure"> Kh√¥ng ch·∫Øc</label>
  </div>

  <!-- 3 -->
  <div class="card">
    <h3>3. B·∫°n c√≥ u·ªëng thay c√† ph√™ kh√¥ng?</h3>
    <label><input type="radio" name="replaceCoffee" value="yes"> C√≥</label>
    <label><input type="radio" name="replaceCoffee" value="sometimes"> Th·ªânh tho·∫£ng</label>
    <label><input type="radio" name="replaceCoffee" value="no"> Kh√¥ng</label>
  </div>

  <!-- 4 -->
  <div class="card">
    <h3>4. B·∫°n c√≥ mu·ªën mua s·∫£n ph·∫©m n√†y?</h3>
    <label><input type="radio" name="buyIntent" value="yes"> C√≥</label>
    <label><input type="radio" name="buyIntent" value="maybe"> C√≥ th·ªÉ</label>
    <label><input type="radio" name="buyIntent" value="no"> Kh√¥ng</label>
  </div>

  <!-- 5 -->
  <div class="card">
    <h3>5. Gi√° ph√π h·ª£p cho 1 vi√™n</h3>
    <label><input type="radio" name="price" value="<15000"> D∆∞·ªõi 15.000 VNƒê</label>
    <label><input type="radio" name="price" value="15000-20000"> 15.000 ‚Äì 20.000 VNƒê</label>
    <label><input type="radio" name="price" value="20000-25000"> 20.000 ‚Äì 25.000 VNƒê</label>
    <label><input type="radio" name="price" value=">25000"> Tr√™n 25.000 VNƒê</label>
  </div>

  <!-- 6 -->
  <div class="card">
    <h3>6. B·∫°n c√≥ m√°y pha vi√™n n√©n (v√≠ d·ª•: Dolce Gusto)?</h3>
    <label><input type="radio" name="machine" value="yes" onclick="toggleMachine(false)"> C√≥</label>
    <label><input type="radio" name="machine" value="no" onclick="toggleMachine(true)"> Kh√¥ng</label>

    <div id="machineFollowUp" style="display:none; margin-top:10px;">
      <p>N·∫øu kh√¥ng, b·∫°n c√≥ s·∫µn s√†ng mua m√°y?</p>
      <label><input type="radio" name="buyMachine" value="yes"> C√≥</label>
      <label><input type="radio" name="buyMachine" value="maybe"> C√≥ th·ªÉ</label>
      <label><input type="radio" name="buyMachine" value="no"> Kh√¥ng</label>
    </div>
  </div>

  <!-- 7 -->
  <div class="card">
    <h3>7. Khi n√†o b·∫°n s·∫Ω u·ªëng? (C√≥ th·ªÉ ch·ªçn nhi·ªÅu ƒë√°p √°n)</h3>
    <label><input type="checkbox" name="when" value="morning"> Bu·ªïi s√°ng</label>
    <label><input type="checkbox" name="when" value="work"> L√†m vi·ªác / H·ªçc t·∫≠p</label>
    <label><input type="checkbox" name="when" value="sport"> Tr∆∞·ªõc ho·∫∑c sau t·∫≠p th·ªÉ thao</label>
    <label><input type="checkbox" name="when" value="evening"> Bu·ªïi t·ªëi</label>
    <label><input type="checkbox" name="when" value="unsure"> Ch∆∞a r√µ</label>
  </div>

  <!-- 8 -->
  <div class="card">
    <h3>8. ƒê·ªô tu·ªïi</h3>
    <label><input type="radio" name="age" value="18-25"> 18‚Äì25</label>
    <label><input type="radio" name="age" value="26-35"> 26‚Äì35</label>
    <label><input type="radio" name="age" value="36-50"> 36‚Äì50</label>
    <label><input type="radio" name="age" value="50+"> Tr√™n 50</label>
  </div>

  <!-- 9 -->
  <div class="card">
    <h3>9. B·∫°n c√≥ gi·ªõi thi·ªáu cho b·∫°n b√®?</h3>
    <label><input type="radio" name="recommend" value="yes"> C√≥</label>
    <label><input type="radio" name="recommend" value="maybe"> C√≥ th·ªÉ</label>
    <label><input type="radio" name="recommend" value="no"> Kh√¥ng</label>
  </div>

  <!-- Feedback -->
  <div class="card">
    <h3>G√≥p √Ω</h3>
    <textarea name="feedback" rows="4" placeholder="√ù ki·∫øn c·ªßa b·∫°n..."></textarea>
  </div>

  <button type="submit" class="btn primary">G·ª≠i kh·∫£o s√°t</button>

</form>

<script>
function toggleMachine(show) {
  document.getElementById("machineFollowUp").style.display = show ? "block" : "none";
}
</script>


    </div>
  </div>

  <!-- App -->
  <script src="app.js"></script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, runTransaction, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

// ‚úÖ Ginseng global sicher initialisieren (muss VOR ensureLive verwendet werden)
window.Ginseng = window.Ginseng || {};
window.Ginseng._live = window.Ginseng._live || { testerId: null, cityCode: null };



  const firebaseConfig = {
    databaseURL: "https://rote-ginseng-vn-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const pad4 = (n) => String(n).padStart(4, "0");


function cityToCode(metaCity) {
  const v = String(metaCity || "").toLowerCase().trim();
  if (v === "dalat" || v === "da lat") return "DL";
  if (v === "saigon" || v === "ho chi minh" || v === "hcm" || v === "hochiminh") return "SG";
  // Default: DaLat (weil du gerade nur DaLat testest)
  return "DL";
}


  async function generateTesterId(cityCode) {
    const counterRef = ref(db, `counters/${cityCode}`);
    const res = await runTransaction(counterRef, (cur) => (cur ?? 0) + 1);
    const next = res.snapshot.val();
    return `${cityCode}-${pad4(next)}`;
  }

  async function publishLiveId(cityCode, testerId) {
    await set(ref(db, `live/${cityCode}/currentTesterId`), {
      tester_id: testerId,
      ts_utc: serverTimestamp()
    });
  }

// ‚úÖ NEU: Sofort-ID generieren + live publishen (einmalig)
async function ensureLiveTesterId(metaCity) {
  const cityCode = cityToCode(metaCity);

  // Wenn schon erzeugt: wiederverwenden
  if (window.Ginseng._live.testerId && window.Ginseng._live.cityCode === cityCode) {
    return window.Ginseng._live.testerId;
  }

  const testerId = await generateTesterId(cityCode);

  // merken (damit Submit sp√§ter NICHT neu generiert)
  window.Ginseng._live.testerId = testerId;
  window.Ginseng._live.cityCode = cityCode;

  // sofort an Observer senden
  await publishLiveId(cityCode, testerId);

  // optional: local fallback (Observer kann das auch lesen)
  localStorage.setItem(`liveTesterId_${cityCode}`, testerId);
  localStorage.setItem("ginseng_last_tester_id", testerId);

  return testerId;
}

// ‚úÖ nach au√üen geben, damit der normale <script> das triggern kann
window.Ginseng._ensureLive = ensureLiveTesterId;



  // Nur setzen, wenn dein app.js es nicht schon bereitstellt
//window.Ginseng = window.Ginseng || {};
//window.Ginseng._live = window.Ginseng._live || { testerId: null, cityCode: null };
  if (typeof window.Ginseng.submitSurvey !== "function") {
    window.Ginseng.submitSurvey = async function(payload) {
  const cityCode = cityToCode(payload.meta_city);

  // Tester-ID generieren
const testerId = await ensureLiveTesterId(payload.meta_city);


  // Lokale Zeit / Zeitzone (vom Ger√§t, z.B. Asia/Bangkok)
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
  const now = new Date();

  // lesbarer lokaler Timestamp (stabil, 24h)
  const tsLocal = new Intl.DateTimeFormat("sv-SE", {
    timeZone: tz,
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit",
    hour12: false
  }).format(now).replace(" ", " ");

  // Payload erweitern
  payload.tester_id = testerId;
  payload.meta_city_code = cityCode;

  // NEU: Zeitfelder wie fr√ºher
  payload.timezone = tz;                       // z.B. "Asia/Bangkok"
  payload.ts_local = tsLocal;                  // z.B. "2026-02-11 10:57:29"
  payload.ts_client_utc = now.toISOString();   // z.B. "2026-02-11T03:57:29.827Z"
  payload.tz_offset_min = -now.getTimezoneOffset(); // Bangkok: 420

  // Survey speichern
  await set(ref(db, `surveys/${testerId}`), {
    ...payload,
    ts_server_utc: serverTimestamp() // eindeutiger Name, damit klar ist was was ist
  });

  // Live an Observer senden
  await set(ref(db, `live/${cityCode}/currentTesterId`), {
    tester_id: testerId,
    timezone: tz,
    ts_local: tsLocal,
    ts_server_utc: serverTimestamp()
  });

  localStorage.setItem("ginseng_last_tester_id", testerId);
  return testerId;
};

  }
</script>



  <!-- Survey Logic (safe + fallback) -->
  <script>
    // Fallback, falls app.js nicht l√§dt oder unvollst√§ndig ist
    if (!window.Ginseng) {
      window.Ginseng = {
        initLangButtons: function () {
          const setLang = (lang) => {
            localStorage.setItem("GINSENG_LANG", lang);
            this.renderI18n();
          };


          const btnDe = document.getElementById("btnDe");
          const btnVi = document.getElementById("btnVi");
          const btnEn = document.getElementById("btnEn");
          if (btnDe) btnDe.onclick = () => setLang("de");
          if (btnVi) btnVi.onclick = () => setLang("vi");
          if (btnEn) btnEn.onclick = () => setLang("en");
        },


        renderI18n: function () {
          const lang = localStorage.getItem("GINSENG_LANG") || "vi";
          document.documentElement.lang = lang;
          document.querySelectorAll("[data-de]").forEach((el) => {
            const txt = el.getAttribute("data-" + lang);
            if (txt == null) return;
            if (el.tagName === "OPTION") el.text = txt;
            else el.innerHTML = txt;
          });
        },
        setScale: function(name, value) {
          const input = document.querySelector('input[name="' + name + '"]');
          if (input) input.value = value;
          document.querySelectorAll('button[data-scale="' + name + '"]').forEach((b) => {
            b.classList.toggle("active", b.getAttribute("data-value") === String(value));
          });
        },
        t: function(map) {
          const lang = localStorage.getItem("GINSENG_LANG") || "vi";
          return (map && (map[lang] || map.vi || map.en || map.de)) || "";
        }
      };
    } else {
      // Falls app.js existiert, aber t() nicht: erg√§nzen
      if (typeof window.Ginseng.t !== "function") {
        window.Ginseng.t = function(map) {
          const lang = localStorage.getItem("GINSENG_LANG") || document.documentElement.lang || "vi";
          return (map && (map[lang] || map.vi || map.en || map.de)) || "";
        };
      }
    }

    function updateQ16() {
      const repurchaseHidden = document.querySelector('input[name="q15_repurchase"]');
      const q16Block = document.getElementById("q16_block");
      if (!repurchaseHidden || !q16Block) return;
      const v = Number(repurchaseHidden.value || "0");
      q16Block.style.display = (v > 0 && v <= 2) ? "block" : "none";
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Wichtig: immer rendern (zus√§tzlich zu app.js)
      if (window.Ginseng.initLangButtons) window.Ginseng.initLangButtons();
      if (window.Ginseng.renderI18n) window.Ginseng.renderI18n();

        // ‚úÖ NEU: Sofort beim √ñffnen der Befragung eine Live-ID erzeugen/pushen
  (async () => {
    try {
      const cityEl = document.getElementById("city");
      const metaCity = cityEl ? (cityEl.value || "saigon") : "saigon";

      if (window.Ginseng && typeof window.Ginseng._ensureLive === "function") {
        await window.Ginseng._ensureLive(metaCity);
      }
    } catch (e) {
      console.warn("Live-ID Start fehlgeschlagen:", e);
    }
  })();

        // ‚úÖ NEU: Wenn City ge√§ndert wird -> neue Live-ID f√ºr neuen City-Code generieren
      const cityElLive = document.getElementById("city");
      if (cityElLive) {
        cityElLive.addEventListener("change", async () => {
          try {
            const metaCity = cityElLive.value || "saigon";
            if (window.Ginseng && typeof window.Ginseng._ensureLive === "function") {
              await window.Ginseng._ensureLive(metaCity);
            }
          } catch (e) {
            console.warn("Live-ID City change failed:", e);
          }
        });
      }



      // Skalen klickbar
      document.querySelectorAll('button.dot[data-scale][data-value]').forEach((btn) => {
        btn.addEventListener("click", () => {
          const scaleName = btn.getAttribute("data-scale");
          const value = btn.getAttribute("data-value");
          window.Ginseng.setScale(scaleName, value);
          if (scaleName === "q15_repurchase") updateQ16();
        });
      });

      // Other Textfeld
      const otherChk = document.getElementById("q16_otherChk");
      const otherTxt = document.getElementById("q16_otherText");
      if (otherChk && otherTxt) {
        const syncOther = () => {
          otherTxt.style.display = otherChk.checked ? "block" : "none";
          if (!otherChk.checked) otherTxt.value = "";
        };
        otherChk.addEventListener("change", syncOther);
        syncOther();
      }

      updateQ16();

      // Submit
      const form = document.getElementById("surveyForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }


        // Skalen-Validierung (hidden inputs)
        const requiredScales = ["q2b_mouthfeel","q6_tooCheap","q7_goodValue","q8_expOk","q9_tooExp","q15_repurchase","q14_spend"];
        for (const k of requiredScales) {
          const v = (document.querySelector('input[name="' + k + '"]') || {}).value || "";
          if (v === "") {
            alert(window.Ginseng.t({
              de: "Bitte alle Skalen ausf√ºllen.",
              vi: "Vui l√≤ng tr·∫£ l·ªùi ƒë·∫ßy ƒë·ªß c√°c thang ƒëi·ªÉm.",
              en: "Please complete all scale questions."
            }));
            return;
          }
        }

        const fd = new FormData(form);

        // Meta
        const roleEl = document.getElementById("role");
        const cityEl = document.getElementById("city");
        if (roleEl) fd.set("meta_role", roleEl.value || "");
        if (cityEl) fd.set("meta_city", cityEl.value || "");

        // Multi-select
        const q16Reasons = Array.from(document.querySelectorAll('input[name="q16_reason"]:checked')).map(x => x.value);
        if (q16Reasons.length) fd.set("q16_reason", JSON.stringify(q16Reasons));

        // Object payload
        const payload = {};
        fd.forEach((v, k) => payload[k] = v);
        payload.ts = new Date().toISOString();
        payload.lang = (localStorage.getItem("GINSENG_LANG") || document.documentElement.lang || "vi");

        try {
          // optional: falls du sp√§ter in app.js eine save/submit Funktion hast
          if (typeof window.Ginseng.submitSurvey === "function") {
            await window.Ginseng.submitSurvey(payload);
          } else if (typeof window.Ginseng.saveSurvey === "function") {
            await window.Ginseng.saveSurvey(payload);
          } else {
            localStorage.setItem("ginseng_pilot_last_submission", JSON.stringify(payload));
          }

          window.location.href = "thanks.html";
        } catch (err) {
          console.error(err);
          alert(window.Ginseng.t({
            de: "Senden hat nicht geklappt. Bitte versuche es erneut.",
            vi: "G·ª≠i kh√¥ng th√†nh c√¥ng. Vui l√≤ng th·ª≠ l·∫°i.",
            en: "Submit failed. Please try again."
          }));
        }
      });
    });
  </script>
</body>
</html>
