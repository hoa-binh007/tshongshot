<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Khảo sát Hong Shot (Đà Lạt)</title>
  

  <style>
    html, body {
  background: #ffffff !important;
  color: #000000 !important;
}

.wrap, .card {
  background: #ffffff !important;
  color: #000000 !important;
}

* {
  color: #000000 !important;
}

    .card { margin-bottom: 14px; }
    .row { display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .btn.primary { cursor:pointer; }
    .hero { width:100%; height:auto; border-radius:14px; display:block; margin:0 0 12px 0; }
    .small { opacity:.85; font-size:.95rem; }
  </style>

  

</head>

<body>
  <div class="wrap">
    <div class="card">

      <!-- HEADER / CLIFFHANGER (Bild oben) -->
      <!-- WICHTIG: Lege das Bild nach public/media/hongshot_header.jpg -->
      <img class="hero" src="../media/hongshot_header.jpg" alt="HONG SHOT">

      <div class="row">
        <div class="small">Khảo sát nhanh – Đà Lạt</div>
      </div>

      <h1>Khảo sát nhanh (Bản cuối – Đà Lạt)</h1>
      <p>Chọn nhanh. Ẩn danh. Mất khoảng 30–60 giây.</p>

      <form id="surveyForm" novalidate>

     <!-- Q0 -->
<div class="card">
  <h3>0. Bạn đã từng uống Hồng Sâm (Nhân sâm đỏ Hàn Quốc) chưa?</h3>
  <label><input type="radio" name="ginsengExperience" value="never" required> Chưa bao giờ</label><br>
  <label><input type="radio" name="ginsengExperience" value="1-2"> Đã uống 1–2 lần</label><br>
  <label><input type="radio" name="ginsengExperience" value="often"> Uống thường xuyên</label>
</div>

<!-- 1 -->
<div class="card">
  <h3>1. Sau khi uống 1 phần thử (1 ly tiêu chuẩn), bạn đánh giá hương vị như thế nào?</h3>
  <label><input type="radio" name="taste" value="5" required> Rất ngon</label><br>
  <label><input type="radio" name="taste" value="4"> Ngon</label><br>
  <label><input type="radio" name="taste" value="3"> Bình thường</label><br>
  <label><input type="radio" name="taste" value="2"> Không ngon</label><br>
  <label><input type="radio" name="taste" value="1"> Rất khó uống</label>
</div>

<!-- 2 -->
<div class="card">
  <h3>2. Theo bạn, Hồng Sâm Hàn Quốc có vai trò như thế nào trong văn hóa và sức khỏe của người Việt?</h3>
  <label><input type="radio" name="culturalValue" value="very_important" required> Rất quan trọng</label><br>
  <label><input type="radio" name="culturalValue" value="important"> Quan trọng</label><br>
  <label><input type="radio" name="culturalValue" value="normal"> Bình thường</label><br>
  <label><input type="radio" name="culturalValue" value="not_important"> Không quan trọng</label>
</div>



<!-- 3 -->
<div class="card">
  <h3>3. Bạn nghĩ sản phẩm này phù hợp nhất trong tình huống nào?</h3>
  <label><input type="radio" name="usageFit" value="work" required> Khi làm việc / cần tập trung</label><br>
  <label><input type="radio" name="usageFit" value="health"> Khi muốn bồi bổ sức khỏe</label><br>
  <label><input type="radio" name="usageFit" value="relax"> Khi thư giãn</label><br>
  <label><input type="radio" name="usageFit" value="gift"> Làm quà tặng</label><br>
  <label><input type="radio" name="usageFit" value="unsure"> Chưa rõ</label>
</div>


<!-- 4 (Machine barrier + 2.8tr hint) -->
<div class="card">
  <h3>4. Bạn có máy pha viên nén (ví dụ: Dolce Gusto) không?</h3>
  <p style="margin:6px 0 10px; opacity:.85;">
    (Giá máy khoảng 2,8 triệu VNĐ)
  </p>
  <label><input type="radio" name="machine" value="have" required> Đã có máy</label><br>
  <label><input type="radio" name="machine" value="buy"> Sẽ mua máy</label><br>
  <label><input type="radio" name="machine" value="no"> Không muốn mua máy</label>
</div>

<!-- 5 -->
<div class="card">
  <h3>5. Nếu viên nén được bán tại siêu thị/cửa hàng, bạn có mua không? Mục đích mua hàng của bạn là gì? </h3>

  <label>
    <input type="radio" name="buyIntent" value="yes" required>
    Chắc chắn mua (để sử dụng cho bản thân)
  </label><br>

  <label>
    <input type="radio" name="buyIntent" value="gift">
    Chắc chắn mua (để làm quà tặng)
  </label><br>

  <label>
    <input type="radio" name="buyIntent" value="maybe_self">
    Có thể mua (cho bản thân)
  </label><br>

  <label>
    <input type="radio" name="buyIntent" value="maybe_gift">
    Có thể mua (làm quà)
  </label><br>

  <label>
    <input type="radio" name="buyIntent" value="no">
    Không mua
  </label>
</div>


<!-- 6 (Price home) -->
<div class="card">
  <h3>6. Với chất lượng Hồng Sâm Hàn Quốc chính hãng, mức giá nào sau đây cho 1 ly là hợp lý?</h3>
  <label><input type="radio" name="price" value="<35000" required> Dưới 35.000 VNĐ</label><br>
  <label><input type="radio" name="price" value="35000-45000"> 35.000 – 45.000 VNĐ</label><br>
  <label><input type="radio" name="price" value="45000-55000"> 45.000 – 55.000 VNĐ</label><br>
  <label><input type="radio" name="price" value=">55000"> Trên 55.000 VNĐ</label>
</div>

<!-- 7 (Street model) -->
<div class="card">
  <h3>7. Nếu được pha sẵn và bán tại quầy/xe đẩy ngoài đường, bạn có chấp nhận giá trên 55.000 VNĐ cho 1 ly không?</h3>
  <label><input type="radio" name="streetPrice55" value="yes" required> Có</label><br>
  <label><input type="radio" name="streetPrice55" value="maybe"> Có thể</label><br>
  <label><input type="radio" name="streetPrice55" value="no"> Không</label>
</div>

<!-- 8-->
<div class="card">
  <h3>9. Độ tuổi</h3>
  <label><input type="radio" name="age" value="18-25" required> 18–25</label><br>
  <label><input type="radio" name="age" value="26-35"> 26–35</label><br>
  <label><input type="radio" name="age" value="36-50"> 36–50</label><br>
  <label><input type="radio" name="age" value="50+"> Trên 50</label>
</div>



        <!-- Feedback -->
        <div class="card">
          <h3>Góp ý (tùy chọn)</h3>
          <textarea name="feedback" rows="3" placeholder="Ý kiến của bạn..."></textarea>
        </div>

        <button type="submit" class="btn primary">Gửi khảo sát</button>
      </form>

    </div>
  </div>

  <!-- App (optional) -->
  <script src="app.js"></script>

  <!-- Firebase + Logic (DaLat only, no events paths) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, runTransaction, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      databaseURL: "https://rote-ginseng-vn-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const CITY_CODE = "DL";   // Da Lat only
    const CITY_NAME = "DaLat";

    const pad4 = (n) => String(n).padStart(4, "0");

    async function generateTesterId() {
      const counterRef = ref(db, `counters/${CITY_CODE}`);
      const res = await runTransaction(counterRef, (cur) => (cur ?? 0) + 1);
      const next = res.snapshot.val();
      return `${CITY_CODE}-${pad4(next)}`;
    }

    async function publishLiveId(testerId) {
      await set(ref(db, `live/${CITY_CODE}/currentTesterId`), {
        tester_id: testerId,
        ts_utc: serverTimestamp()
      });
    }

    async function ensureLiveTesterId() {
      const key = "ginseng_last_tester_id";
      const cached = localStorage.getItem(key);

      // Wenn schon eine ID im Session-Kontext existiert, reuse (verhindert doppelte IDs bei refresh)
      if (cached && cached.startsWith(`${CITY_CODE}-`)) {
        return cached;
      }

      const testerId = await generateTesterId();
      localStorage.setItem(key, testerId);

      // Live publish für Operator/Observer
      await publishLiveId(testerId);

      return testerId;
    }

    window.Ginseng = window.Ginseng || {};
    window.Ginseng.submitSurvey = async function(payload) {
      const testerId = await ensureLiveTesterId();

      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
      const now = new Date();

      const tsLocal = new Intl.DateTimeFormat("sv-SE", {
        timeZone: tz,
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      }).format(now).replace(" ", " ");

      payload.tester_id = testerId;
      payload.meta_city = CITY_NAME;
      payload.meta_city_code = CITY_CODE;

      payload.timezone = tz;
      payload.ts_local = tsLocal;
      payload.ts_client_utc = now.toISOString();
      payload.tz_offset_min = -now.getTimezoneOffset();

      // Write only to allowed paths: surveys + live + counters (rules compatible)
      await set(ref(db, `surveys/${testerId}`), {
        ...payload,
        ts_server_utc: serverTimestamp()
      });

      await set(ref(db, `live/${CITY_CODE}/currentTesterId`), {
        tester_id: testerId,
        timezone: tz,
        ts_local: tsLocal,
        ts_server_utc: serverTimestamp()
      });

      // Optional: nach Submit neue ID erzwingen für nächsten Tester
      localStorage.removeItem("ginseng_last_tester_id");

      return testerId;
    };

    // Beim Öffnen direkt ID an Operator/Observer schicken (optional, aber praktisch)
    (async () => {
      try { await ensureLiveTesterId(); } catch (e) { console.warn(e); }
    })();
  </script>

  <!-- UI + Submit wiring (VI only) -->
  <script>
    function toggleMachineFollowUp() {
      const machine = document.querySelector('input[name="machine"]:checked')?.value || "";
      const follow = document.getElementById("machineFollowUp");
      if (!follow) return;

      follow.style.display = (machine === "no") ? "block" : "none";
      if (machine !== "no") {
        document.querySelectorAll('input[name="buyMachine"]').forEach(i => i.checked = false);
      }
    }

    function validateForm(form) {
      if (form.checkValidity()) return true;
      form.reportValidity();
      return false;
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('input[name="machine"]').forEach(i => {
        i.addEventListener("change", toggleMachineFollowUp);
      });
      toggleMachineFollowUp();

      const form = document.getElementById("surveyForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!validateForm(form)) return;

        const fd = new FormData(form);

        // Multi-select "when" als JSON-Array
        const whenArr = Array.from(document.querySelectorAll('input[name="when"]:checked')).map(x => x.value);
        fd.delete("when");
        fd.set("when", JSON.stringify(whenArr));

        // Wenn machine != no -> buyMachine löschen
        const machine = document.querySelector('input[name="machine"]:checked')?.value || "";
        if (machine !== "no") fd.delete("buyMachine");

        const payload = {};
        fd.forEach((v, k) => payload[k] = v);

        payload.lang = "vi";
        payload.client_ts = new Date().toISOString();

        try {
          if (window.Ginseng && typeof window.Ginseng.submitSurvey === "function") {
            await window.Ginseng.submitSurvey(payload);
          } else {
            localStorage.setItem("ginseng_pilot_last_submission", JSON.stringify(payload));
          }

          window.location.href = "thanks.html";
        } catch (err) {
          console.error(err);
          alert("Gửi không thành công. Vui lòng thử lại.");
        }
      });
    });
  </script>
</body>
</html>
