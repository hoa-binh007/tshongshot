<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Khảo sát Hong Shot (Đà Lạt)</title>
  <link rel="stylesheet" href="app.css"/>

  <style>
    .card { margin-bottom: 14px; }
    .row { display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .btn.primary { cursor:pointer; }
    .hero { width:100%; height:auto; border-radius:14px; display:block; margin:0 0 12px 0; }
    .small { opacity:.85; font-size:.95rem; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <!-- HEADER / CLIFFHANGER (Bild oben) -->
      <!-- WICHTIG: Lege das Bild nach public/media/hongshot_header.jpg -->
      <img class="hero" src="../media/hongshot_header.jpg" alt="HONG SHOT">

      <div class="row">
        <div class="small">Khảo sát nhanh – Đà Lạt</div>
      </div>

      <h1>Khảo sát nhanh (Bản cuối – Đà Lạt)</h1>
      <p>Chọn nhanh. Ẩn danh. Mất khoảng 30–60 giây.</p>

      <form id="surveyForm" novalidate>

        <!-- Q0 -->
        <div class="card">
          <h3>0. Bạn đã từng uống Hồng Sâm (Nhân sâm đỏ Hàn Quốc) chưa?</h3>
          <label><input type="radio" name="ginsengExperience" value="never" required> Chưa bao giờ</label><br>
          <label><input type="radio" name="ginsengExperience" value="1-2"> Đã uống 1–2 lần</label><br>
          <label><input type="radio" name="ginsengExperience" value="often"> Uống thường xuyên</label>
        </div>

        <!-- 1 -->
        <div class="card">
          <h3>1. Hương vị</h3>
          <label><input type="radio" name="taste" value="5" required> Rất ngon</label><br>
          <label><input type="radio" name="taste" value="4"> Ngon</label><br>
          <label><input type="radio" name="taste" value="3"> Bình thường</label><br>
          <label><input type="radio" name="taste" value="2"> Không ngon</label><br>
          <label><input type="radio" name="taste" value="1"> Rất khó uống</label>
        </div>

        <!-- 2 -->
        <div class="card">
          <h3>2. Sau khi uống bạn có thấy tỉnh táo hơn?</h3>
          <label><input type="radio" name="energy" value="yes" required> Có</label><br>
          <label><input type="radio" name="energy" value="little"> Một chút</label><br>
          <label><input type="radio" name="energy" value="no"> Không</label><br>
          <label><input type="radio" name="energy" value="unsure"> Không chắc</label>
        </div>

        <!-- 3 -->
        <div class="card">
          <h3>3. Bạn có uống thay cà phê không?</h3>
          <label><input type="radio" name="replaceCoffee" value="yes" required> Có</label><br>
          <label><input type="radio" name="replaceCoffee" value="sometimes"> Thỉnh thoảng</label><br>
          <label><input type="radio" name="replaceCoffee" value="no"> Không</label>
        </div>

        <!-- 4 -->
        <div class="card">
          <h3>4. Nếu sản phẩm này có sẵn tại cửa hàng/siêu thị, bạn có mua không?</h3>
          <label><input type="radio" name="buyIntent" value="yes" required> Chắc chắn mua</label><br>
          <label><input type="radio" name="buyIntent" value="maybe"> Có thể mua</label><br>
          <label><input type="radio" name="buyIntent" value="no"> Không mua</label>
        </div>

        <!-- 5 (Preis für 1 ly) -->
        <div class="card">
          <h3>5. Với chất lượng Hồng Sâm Hàn Quốc chính hãng, mức giá nào sau đây cho 1 ly là hợp lý?</h3>
          <label><input type="radio" name="price" value="<35000" required> Dưới 35.000 VNĐ</label><br>
          <label><input type="radio" name="price" value="35000-45000"> 35.000 – 45.000 VNĐ</label><br>
          <label><input type="radio" name="price" value="45000-55000"> 45.000 – 55.000 VNĐ</label><br>
          <label><input type="radio" name="price" value=">55000"> Trên 55.000 VNĐ</label>
        </div>

        <!-- 6 -->
        <div class="card">
          <h3>6. Bạn có máy pha viên nén (ví dụ: Dolce Gusto)?</h3>
          <label><input type="radio" name="machine" value="yes" required> Có</label><br>
          <label><input type="radio" name="machine" value="no"> Không</label>

          <div id="machineFollowUp" style="display:none; margin-top:10px;">
            <p>Nếu không, bạn có sẵn sàng mua máy?</p>
            <label><input type="radio" name="buyMachine" value="yes"> Có</label><br>
            <label><input type="radio" name="buyMachine" value="maybe"> Có thể</label><br>
            <label><input type="radio" name="buyMachine" value="no"> Không</label>
          </div>
        </div>

        <!-- 7 -->
        <div class="card">
          <h3>7. Khi nào bạn sẽ uống? (Có thể chọn nhiều đáp án)</h3>
          <label><input type="checkbox" name="when" value="morning"> Buổi sáng</label><br>
          <label><input type="checkbox" name="when" value="work"> Làm việc / Học tập</label><br>
          <label><input type="checkbox" name="when" value="sport"> Trước hoặc sau tập thể thao</label><br>
          <label><input type="checkbox" name="when" value="evening"> Buổi tối</label><br>
          <label><input type="checkbox" name="when" value="unsure"> Chưa rõ</label>
        </div>

        <!-- 8 -->
        <div class="card">
          <h3>8. Độ tuổi</h3>
          <label><input type="radio" name="age" value="18-25" required> 18–25</label><br>
          <label><input type="radio" name="age" value="26-35"> 26–35</label><br>
          <label><input type="radio" name="age" value="36-50"> 36–50</label><br>
          <label><input type="radio" name="age" value="50+"> Trên 50</label>
        </div>

        <!-- 9 -->
        <div class="card">
          <h3>9. Bạn có giới thiệu cho bạn bè?</h3>
          <label><input type="radio" name="recommend" value="yes" required> Có</label><br>
          <label><input type="radio" name="recommend" value="maybe"> Có thể</label><br>
          <label><input type="radio" name="recommend" value="no"> Không</label>
        </div>

        <!-- Feedback -->
        <div class="card">
          <h3>Góp ý (tùy chọn)</h3>
          <textarea name="feedback" rows="3" placeholder="Ý kiến của bạn..."></textarea>
        </div>

        <button type="submit" class="btn primary">Gửi khảo sát</button>
      </form>

    </div>
  </div>

  <!-- App (optional) -->
  <script src="app.js"></script>

  <!-- Firebase + Logic (DaLat only, no events paths) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, runTransaction, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      databaseURL: "https://rote-ginseng-vn-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const CITY_CODE = "DL";   // Da Lat only
    const CITY_NAME = "DaLat";

    const pad4 = (n) => String(n).padStart(4, "0");

    async function generateTesterId() {
      const counterRef = ref(db, `counters/${CITY_CODE}`);
      const res = await runTransaction(counterRef, (cur) => (cur ?? 0) + 1);
      const next = res.snapshot.val();
      return `${CITY_CODE}-${pad4(next)}`;
    }

    async function publishLiveId(testerId) {
      await set(ref(db, `live/${CITY_CODE}/currentTesterId`), {
        tester_id: testerId,
        ts_utc: serverTimestamp()
      });
    }

    async function ensureLiveTesterId() {
      const key = "ginseng_last_tester_id";
      const cached = localStorage.getItem(key);

      // Wenn schon eine ID im Session-Kontext existiert, reuse (verhindert doppelte IDs bei refresh)
      if (cached && cached.startsWith(`${CITY_CODE}-`)) {
        return cached;
      }

      const testerId = await generateTesterId();
      localStorage.setItem(key, testerId);

      // Live publish für Operator/Observer
      await publishLiveId(testerId);

      return testerId;
    }

    window.Ginseng = window.Ginseng || {};
    window.Ginseng.submitSurvey = async function(payload) {
      const testerId = await ensureLiveTesterId();

      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
      const now = new Date();

      const tsLocal = new Intl.DateTimeFormat("sv-SE", {
        timeZone: tz,
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      }).format(now).replace(" ", " ");

      payload.tester_id = testerId;
      payload.meta_city = CITY_NAME;
      payload.meta_city_code = CITY_CODE;

      payload.timezone = tz;
      payload.ts_local = tsLocal;
      payload.ts_client_utc = now.toISOString();
      payload.tz_offset_min = -now.getTimezoneOffset();

      // Write only to allowed paths: surveys + live + counters (rules compatible)
      await set(ref(db, `surveys/${testerId}`), {
        ...payload,
        ts_server_utc: serverTimestamp()
      });

      await set(ref(db, `live/${CITY_CODE}/currentTesterId`), {
        tester_id: testerId,
        timezone: tz,
        ts_local: tsLocal,
        ts_server_utc: serverTimestamp()
      });

      // Optional: nach Submit neue ID erzwingen für nächsten Tester
      localStorage.removeItem("ginseng_last_tester_id");

      return testerId;
    };

    // Beim Öffnen direkt ID an Operator/Observer schicken (optional, aber praktisch)
    (async () => {
      try { await ensureLiveTesterId(); } catch (e) { console.warn(e); }
    })();
  </script>

  <!-- UI + Submit wiring (VI only) -->
  <script>
    function toggleMachineFollowUp() {
      const machine = document.querySelector('input[name="machine"]:checked')?.value || "";
      const follow = document.getElementById("machineFollowUp");
      if (!follow) return;

      follow.style.display = (machine === "no") ? "block" : "none";
      if (machine !== "no") {
        document.querySelectorAll('input[name="buyMachine"]').forEach(i => i.checked = false);
      }
    }

    function validateForm(form) {
      if (form.checkValidity()) return true;
      form.reportValidity();
      return false;
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('input[name="machine"]').forEach(i => {
        i.addEventListener("change", toggleMachineFollowUp);
      });
      toggleMachineFollowUp();

      const form = document.getElementById("surveyForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!validateForm(form)) return;

        const fd = new FormData(form);

        // Multi-select "when" als JSON-Array
        const whenArr = Array.from(document.querySelectorAll('input[name="when"]:checked')).map(x => x.value);
        fd.delete("when");
        fd.set("when", JSON.stringify(whenArr));

        // Wenn machine != no -> buyMachine löschen
        const machine = document.querySelector('input[name="machine"]:checked')?.value || "";
        if (machine !== "no") fd.delete("buyMachine");

        const payload = {};
        fd.forEach((v, k) => payload[k] = v);

        payload.lang = "vi";
        payload.client_ts = new Date().toISOString();

        try {
          if (window.Ginseng && typeof window.Ginseng.submitSurvey === "function") {
            await window.Ginseng.submitSurvey(payload);
          } else {
            localStorage.setItem("ginseng_pilot_last_submission", JSON.stringify(payload));
          }

          window.location.href = "thanks.html";
        } catch (err) {
          console.error(err);
          alert("Gửi không thành công. Vui lòng thử lại.");
        }
      });
    });
  </script>
</body>
</html>
